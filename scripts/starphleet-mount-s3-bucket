#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-mount-s3-bucket
###
### Optionally mount an S3 Bucket to be available to
### containers at the following location:
###
### /var/data/s3

source `which tools`
set -e

run_as_root_or_die

# Location for LXC s3 bucket
S3_BUCKET_MOUNT_DESTINATION="/var/lib/lxc/data/s3"

# This command is intended to be mostly run at install time so instead of
# taking the config as an argument, I'm prompting for the config for convenience
cat << EOF

----------

(Optional) Globally writable S3 bucket using S3FS

Please provide Amazon credentials in the form of:

     S3BucketName:S3SAccessKey:SecretKey

Leave this option blank to skip this feature.

----------

EOF

read -p "S3 Configuration:  " S3_CONFIGURATION


# If they left things blank above the default behavior is to skip
# configuration all together
[ -z "${S3_CONFIGURATION}" ] && exit 0

S3_BUCKET_NAME=$(echo "${S3_CONFIGURATION}" | cut -f1 -d ":")
S3_ACCESS_KEY=$(echo "${S3_CONFIGURATION}" | cut -f2 -d ":")
S3_SECRET_KEY=$(echo "${S3_CONFIGURATION}" | cut -f3 -d ":")

# If things don't parse correctly or any field is blank - punt with an error
[ -z "${S3_BUCKET_NAME}" ] || [ -z "${S3_ACCESS_KEY}" ] || [ -z "${S3_SECRET_KEY}" ] && \
   error "Something went wrong with parse" && \
   exit 1

# Install s3fs
if [ ! -f "/usr/bin/s3fs" ]; then
  cd /tmp
  apt-get update -y
  apt-get install -y build-essential git libfuse-dev libcurl4-openssl-dev libxml2-dev mime-support automake libtool pkg-config libssl-dev
  git clone https://github.com/s3fs-fuse/s3fs-fuse
  cd s3fs-fuse/
  ./autogen.sh
  ./configure --prefix=/usr --with-openssl
  make
  make install
fi

# Create our destination
[ ! -d "${S3_BUCKET_MOUNT_DESTINATION}" ] && mkdir -p "${S3_BUCKET_MOUNT_DESTINATION}"

# If the s3 bucket is already installed assume we are replacing it and unmount the current destination
MOUNTED_CHECK=$(df -P -T "${S3_BUCKET_MOUNT_DESTINATION}" | tail -n +2 | awk '{print $2}')
[ "${MOUNTED_CHECK}" = "fuse.s3fs" ] && umount "${S3_BUCKET_MOUNT_DESTINATION}"

chown ubuntu:ubuntu "${S3_BUCKET_MOUNT_DESTINATION}"

# Create the s3fs password file
echo "${S3_ACCESS_KEY}:${S3_SECRET_KEY}" > "/home/ubuntu/.passwd-s3fs"
chmod 400 "/home/ubuntu/.passwd-s3fs"
chown ubuntu:ubuntu "/home/ubuntu/.passwd-s3fs"

su -l ubuntu -c "/usr/bin/s3fs '${S3_BUCKET_OPTIONS}' '${S3_BUCKET_NAME}' '${S3_BUCKET_MOUNT_DESTINATION}'"
