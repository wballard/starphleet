description "An individual ordered repository needs to be served"

start on starphleet_orders
stop on stopping starphleet

instance $local

script
  source /var/starphleet/.headquarters
  #the monitoring triggered in the git repository, so we need to go up a level
  #to write out the cid file
  cd "${local}/.."
  ORDER=$(pwd)
  #run at the current SHA
  get_CURRENT_SHA "${local}"
  SERVICE_SHA=${CURRENT_SHA}
  get_CURRENT_SHA "${HEADQUARTERS_LOCAL}"
  ORDER_SHA=${CURRENT_SHA}
  SHORT_ORDER=$(basename "${ORDER}")
  #count on upstart to be the daemon manager to serve each order
  #with a tiny bit of a friendly name so
  #that initctl list doesn't just have a pile of SHAs in there
  SERVICE_NAME="${ORDER_SHA}-${SHORT_ORDER}-${SERVICE_SHA}"
  if initctl list | grep "${SERVICE_NAME}"; then
    echo -n
  else
    start starphleet_serve_order name="${SERVICE_NAME}" order="${ORDER}"
  fi
end script

