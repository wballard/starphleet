#!/usr/bin/env bash

sudo apt-get -y update
sudo apt-get install -y --force-yes $(cat << FFF
autoconf
bind9-host
bison
build-essential
curl
daemontools
dnsutils
ed
git
imagemagick
iputils-tracepath
libcurl4-openssl-dev
libevent-dev
libglib2.0-dev
libjpeg-dev
libjpeg62
libpng12-0
libpng12-dev
libmagickcore-dev
libmagickwand-dev
libmysqlclient-dev
libpq-dev
libsqlite3-dev
libssl-dev
libssl0.9.8
libxml2-dev
libxslt-dev
mercurial
mysql-client
netcat-openbsd
openjdk-6-jdk
openjdk-6-jre-headless
openssh-client
openssh-server
python-dev
ruby1.9.1-dev
socat
sqlite3
telnet
zlib1g-dev
bsdmainutils
groff
libyaml-dev
python-dev
python-docutils
python-pip
FFF
)

## This is a working set of steps as of Nov 1, 2018 to get a modern
## version of the AWS Cli running on Ubuntu 14.04.  Every few months
## the endzone moves and upstream complications add complexity to the
## process.  As such, it's possible this will need more adjustments
## at a later date.  This may be removable when support for Ubuntu 14.04
## is deprecated.
set +e
## Because:  https://github.com/aws/aws-cli/issues/2999#issuecomment-356019306
sudo apt-get remove awscli --assume-yes
sudo pip uninstall boto3 -y
sudo pip uninstall boto -y
sudo pip uninstall botocore -y
# Fix bug caused by apt/ubuntu
sudo rm -rf /usr/local/lib/python2.7/dist-packages/botocore-*.dist-info
sudo pip install botocore --force-reinstall --upgrade
#######
## Because: https://github.com/aws/aws-cli/issues/3007#issuecomment-350797161
sudo pip install --upgrade s3transfer
sudo rm -rf /tmp/pip_build_root/PyYAML
sudo pip install awscli --force-reinstall --upgrade
set -e

sudo aws s3 cp s3://glg-deployment-packages/secrets /usr/bin/secrets && echo "...Success"
sudo chmod +x /usr/bin/secrets

## ruby superstition
export HOME=/
sudo gem install bundler -v 1.16.5
