#!/usr/bin/env bash

#this is a provisioning script, it is designed to be run under Vagrant
#as root, with the starphleet source tree at /starphleet

set -e


apt-get -y update
apt-get -y install --force-yes git curl apt-transport-https lsof ssh
apt-get -y install --force-yes python g++ make git
apt-get -y install --force-yes lxc man
apt-get -y install --force-yes software-properties-common
add-apt-repository -y ppa:nginx/stable
add-apt-repository -y ppa:chris-lea/node.js
apt-get -y update
apt-get -y install --force-yes nginx
apt-get -y install --force-yes nodejs

#initial apt package has nginx running. lame.
/etc/init.d/nginx stop
find /etc/rc* -name '*nginx' | grep nginx | xargs rm

#we will be using bash. period
rm /bin/sh
ln /bin/bash /bin/sh

#now ready for the phleet
/starphleet/provision/phleet

#TODO: add to path
# /starphleet/scripts/starphleet-headquarters

apt-get clean

#if we are on EC2, install the self update job
if curl "http://169.254.169.254/latest/user-data/" --silent --connect-timeout 1; then
  cp /starphleet/provision/ec2/starphleet_install.conf /etc/init/starphleet_install.conf
  HEADQUARTERS=$(curl "http://169.254.169.254/latest/user-data/" --silent | sed -e's/%\([0-9A-F][0-9A-F]\)/\\\\\x\1/g' | xargs echo -e)
  starphleet-headquarters "${HEADQUARTERS}"
fi
